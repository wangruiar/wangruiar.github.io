<!DOCTYPE html>

<head>
  <title>
    数据结构 &middot; wu-kan
  </title>
  
  <meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1"  />
  
  <meta http-equiv="X-UA-Compatible"  content="IE=edge"  />
  
  <meta http-equiv="content-type"  content="text/html; charset=utf-8"  />
  
  <meta name="google-site-verification"  content="YIKi1rBnyUaS-DMYiluseI5kZzTwjCkTFmKkSkMZDJk"  />
  
  <meta name="baidu-site-verification"  content="bEFDJ1LvXb"  />
  
  <meta name="yandex-verification"  content="52253e02830b443c"  />
  
  <link rel="profile"  href="//gmpg.org/xfn/11"  />
  
  <link rel="alternate"  href="/atom.xml"  title="RSS"  type="application/rss+xml"  />
  
  <link rel="apple-touch-icon-precomposed"  href="//www.gravatar.com/avatar/a12c5fff23dde00df79af9aca4e7b6e4?d=wavatar&s=144"  />
  
  <link rel="shortcut icon"  href="//www.gravatar.com/avatar/a12c5fff23dde00df79af9aca4e7b6e4?d=wavatar&s=32"  />
  
  <link rel="stylesheet"  href="//cdn.jsdelivr.net/gh/wu-kan/wu-kan.github.io/public/css/poole.css"  />
  
  <link rel="stylesheet"  href="//cdn.jsdelivr.net/gh/wu-kan/wu-kan.github.io/public/css/syntax.css"  />
  
  <link rel="stylesheet"  href="//cdn.jsdelivr.net/gh/wu-kan/wu-kan.github.io/public/css/lanyon.css"  />
  
  <link rel="stylesheet"  href="/public/css/wu-kan.css"  />
  
  <link rel="stylesheet"  href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.css"  />
  
</head>

<body
  class="theme-base-0d layout-reverse sidebar-overlay">
  
  <script  src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js" >
  </script>
  
  <script  src="//cdn.jsdelivr.net/npm/ribbon.js/dist/ribbon.min.js" >
  </script>
  
  <script  src="//cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js" >
  </script>
  
  <script  src="/public/js/prism.js" >
  </script>
  
  <script  src="/public/js/mermaid.js"  js="//cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"  stylesheet="//cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.css"  markdown_expand="true" >
  </script>
  
  <script  src="/public/js/katex.js"  js="//cdn.jsdelivr.net/npm/katex/dist/katex.min.js"  auto_render="//cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"  stylesheet="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css"  delimiters="true" >
  </script>
  
  <script  src="/public/js/baidu_push.js" >
  </script>
  
  <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
  <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" />
  <!-- Toggleable sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-item">
      
      <div class="ih-item circle effect right_to_left">
        <a class="blog-button" title="WuK">
          <img class="img" src="//www.gravatar.com/avatar/a12c5fff23dde00df79af9aca4e7b6e4?d=wavatar&s=600" alt="img" />
          <small class="info info-back">
            <br/>SYSU17级在读<br/>计科超算方向<br/>永远喜欢水野爱<br/>田宫例四驱车<br/>ACM&ASC
          </small>
        </a>
      </div>
      
      <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=52 src="//music.163.com/outchain/player?type=0&id=155059595&auto=0&height=32"></iframe>
      <div class="sidebar-social">
        
        <a href="/atom.xml" title="rss">
          <i class="fas fa-rss fa-fw"></i>
        </a>
        
        <a href="mailto:wu.kan@foxmail.com" title="wu.kan@foxmail.com">
          <i class="fas fa-envelope fa-fw"></i>
        </a>
        
        <a href="//codeforces.com/profile/WuK" title="WuK">
          <i class="fas fa-chart-bar fw"></i>
        </a>
        
        <a href="//vjudge.net/user/WuK" title="WuK">
          <i class="fas fa-smile fa-fw"></i>
        </a>
        
        <a href="" title="942759535">
          <i class="fab fa-qq fa-fw"></i>
        </a>
        
        <a href="" title="Wu-_-Kan">
          <i class="fab fa-weixin fa-fw"></i>
        </a>
        
        <a href="//github.com/wu-kan" title="github">
          <i class="fab fa-github fa-fw"></i>
        </a>
        
        <a href="//www.zhihu.com/people/wu.kan/activities" title="zhihu">
          <i class="fab fa-zhihu fa-fw"></i>
        </a>
        
      </div>
    </div>
    <nav class="sidebar-nav">
      
      <a class="sidebar-nav-item" href="/">
        <i class="fas fa-home fa-fw"></i> 首页
      </a>
      
      <a class="sidebar-nav-item" href="/about">
        <i class="fab fa-readme fa-fw"></i> 关于
      </a>
      
      <a class="sidebar-nav-item" href="/comments">
        <i class="fas fa-comments fa-fw"></i> 留言
      </a>
      
      <a class="sidebar-nav-item" href="/tags">
        <i class="fas fa-tags fa-fw"></i> 标签
      </a>
      
      <a class="sidebar-nav-item" href="/archive">
        <i class="fas fa-archive fa-fw"></i> 归档
      </a>
      
    </nav>
    <div class="sidebar-item">
      
      <div>
        <script src="/public/simple-jekyll-search/autoloader.js"></script>
      </div>
      
      
      <div>
        <script src="/public/js/jekyll_table_of_contents.js"></script>
      </div>
      
      
      <div>
        <script src="/public/js/run_time.js"></script>
      </div>
      
      
      <div>
        <i class="fas fa-eye fa-fw"></i>
        <span id="busuanzi_value_page_pv"></span>次
      </div>
      <div>
        <i class="fas fa-paw fa-fw"></i>
        <span id="busuanzi_value_site_pv"></span>枚
      </div>
      <div>
        <i class="fas fa-user-friends fa-fw"></i>
        <span id="busuanzi_value_site_uv"></span>人
      </div>
      <script src="//cdn.jsdelivr.net/npm/busuanzi/bsz.pure.mini.js"></script>
      
      
      <div>
        <i class="fas fa-user-edit fa-fw"></i>
        2019-11-09 17:38:24
      </div>
      
      
      <div>
        <i class="fas fa-copyright fa-fw"></i>
        2019
        WuK
        <script async defer src="https://buttons.github.io/buttons.js"></script><a class="github-button" aria-label="Star wu-kan/wu-kan.github.io on GitHub" href="https://github.com/wu-kan/wu-kan.github.io" data-icon="octicon-star" data-show-count="true">Star</a>
      </div>
      
    </div>
  </div>
  <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
  <div class="wrap">
    <h1 class="masthead masthead-title">
      <div class="container">
        数据结构
        <a href="/">
          <small>wu-kan</small>
        </a>
      </div>
    </h1>
    <div class="container content">
      <div class="post">
  
  <small class="post-date">
    
    <i class="fas fa-calendar-day"></i>
    03 Feb 2019
    
    
    <i class="fas fa-file-word"></i>
    15883字
    
    
    <i class="fas fa-coffee"></i>
    53分
    
    
    <span id="/posts/acm/template/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" class="leancloud-visitors" data-flag-title="数据结构">
      <i class="far fa-eye"></i>
      <span class="leancloud-visitors-count"></span>次
    </span>
    
    
    <i class="fas fa-tag"></i>
    ICPC模板
    
    </br>
    <i class="fab fa-creative-commons"></i> <a rel="license" href="//creativecommons.org/licenses/by-sa/4.0/deed.zh">BY-SA 4.0</a>（除特别声明或转载文章外）
  </small>
  
  
  <div class="post-content">
    <p>以下数据结构均采用ll作为值类型，应用时根据需求调整。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">const</span> <span class="n">ll</span> <span class="n">INF</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">;</span>  <span class="c1">//表示（值）正无穷，且两个正无穷相加不会溢出
</span><span class="k">const</span> <span class="kt">int</span> <span class="n">NPOS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//表示（下标）不存在
</span></code></pre></div></div>

<h2 id="离散化">离散化</h2>

<p>在vector基础上的离散化，使用push_back()向其中插值，init()排序并离散化，ask查询离散化之后的值，at/[]运算符查离散前的值。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Ranker</span> <span class="o">:</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">ll</span><span class="o">&gt;</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span> <span class="n">sort</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">()),</span> <span class="n">resize</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">())</span> <span class="o">-</span> <span class="n">begin</span><span class="p">());</span> <span class="p">}</span>
	<span class="kt">int</span> <span class="n">ask</span><span class="p">(</span><span class="n">ll</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">(),</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="并查集">并查集</h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">UnionfindSet</span> <span class="o">:</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
<span class="p">{</span>
	<span class="n">UnionfindSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">merge</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">ask</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">u</span> <span class="o">=</span> <span class="n">ask</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">w</span> <span class="o">!=</span> <span class="n">u</span><span class="p">)</span>
			<span class="n">at</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">int</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">at</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u</span> <span class="o">?</span> <span class="n">at</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">=</span> <span class="n">ask</span><span class="p">(</span><span class="n">at</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="o">:</span> <span class="n">u</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="单调队列和单调栈">单调队列和单调栈</h2>

<p><a href="https://vjudge.net/solution/18456407">使用示例</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">ll</span><span class="o">&gt;</span> <span class="n">pil</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Monotone</span> <span class="o">:</span> <span class="n">deque</span><span class="o">&lt;</span><span class="n">pil</span><span class="o">&gt;</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="k">const</span> <span class="n">pil</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">back</span><span class="p">().</span><span class="n">second</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
			<span class="n">pop_back</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">push_back</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span> <span class="o">-</span> <span class="n">front</span><span class="p">().</span><span class="n">first</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">;)</span>
			<span class="n">pop_front</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="st表">ST表</h2>

<p><a href="https://vjudge.net/solution/14470893">使用示例</a></p>

<p>$O(n\log n)$预处理，$O(1)$求静态区间最小值。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
//可选优化
#define log2(n) LOG2[n]
struct Log : vector&lt;ll&gt;
{
	Log(int N, ll E) : vector&lt;ll&gt;(N, -1)
	{
		for (int i = 1; i &lt; N; ++i)
			at(i) = at(i / E) + 1;
	}
} LOG2(N, 2);
*/</span>
<span class="k">struct</span> <span class="n">SparseTable</span>
<span class="p">{</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ll</span><span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">;</span>
	<span class="n">SparseTable</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">ll</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">)</span> <span class="o">:</span> <span class="n">f</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">f</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span><span class="p">)]);</span>
	<span class="p">}</span>
	<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">log2</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span><span class="p">)]);</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="树状数组">树状数组</h2>

<p>模板中Base是对应的基础版本，支持单点修改区间查询。</p>

<h3 id="一维">一维</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Fenwick</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BaseFenwick</span>
	<span class="p">{</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="n">ll</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">BaseFenwick</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">v</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
		<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">x</span> <span class="o">+=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
				<span class="n">v</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ll</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">x</span><span class="p">;</span> <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
				<span class="n">ans</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
			<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">pair</span><span class="o">&lt;</span><span class="n">BaseFenwick</span><span class="p">,</span> <span class="n">BaseFenwick</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">Fenwick</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">p</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">);</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span> <span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">add</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">w</span><span class="p">);</span> <span class="p">}</span>
	<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">ask</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">ask</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="p">}</span>
	<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ask</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="n">ask</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="二维">二维</h3>

<p>高维的数据结构只要每一维维护低一维的数据（树套树）即可。其余数据结构亦同理。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Fenwick2</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BaseFenwick2</span>
	<span class="p">{</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="n">Fenwick</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">BaseFenwick2</span><span class="p">(</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">v</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="p">{}</span>
		<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">x</span> <span class="o">+=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
				<span class="n">v</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ll</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">x</span><span class="p">;</span> <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
				<span class="n">ans</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">ask</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">pair</span><span class="o">&lt;</span><span class="n">BaseFenwick2</span><span class="p">,</span> <span class="n">BaseFenwick2</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">Fenwick2</span><span class="p">(</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">p</span><span class="p">(</span><span class="n">BaseFenwick2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">BaseFenwick2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">);</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span> <span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">add</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="n">w</span><span class="p">);</span> <span class="p">}</span> <span class="c1">//(l,b)~(r,t)
</span>	<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">ask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">ask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span> <span class="p">}</span>
	<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ask</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">ask</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="动态开点线段树">动态开点线段树</h2>

<p><a href="https://vjudge.net/solution/21600921">使用示例</a>，支持区间线性变换、区间查询（最大值最小值区间和）。</p>

<p>这样写改可持久化也很方便，只要改<code class="highlighter-rouge">down</code>函数为每次都新建节点即可，<a href="https://vjudge.net/solution/21600829">示例</a>。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">SegmentTree</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Seg</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">ll</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">sum</span><span class="p">;</span>
		<span class="kt">void</span> <span class="nf">upd</span><span class="p">(</span><span class="n">ll</span> <span class="n">mul</span><span class="p">,</span> <span class="n">ll</span> <span class="n">add</span><span class="p">)</span> <span class="p">{</span> <span class="n">min</span> <span class="o">=</span> <span class="n">min</span> <span class="o">*</span> <span class="n">mul</span> <span class="o">+</span> <span class="n">add</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="n">max</span> <span class="o">*</span> <span class="n">mul</span> <span class="o">+</span> <span class="n">add</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">*</span> <span class="n">mul</span> <span class="o">+</span> <span class="n">add</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
		<span class="k">friend</span> <span class="n">Seg</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">lc</span><span class="p">,</span> <span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span><span class="n">lc</span><span class="p">.</span><span class="n">l</span><span class="p">,</span> <span class="n">rc</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">rc</span><span class="p">.</span><span class="n">min</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="n">rc</span><span class="p">.</span><span class="n">max</span><span class="p">),</span> <span class="n">lc</span><span class="p">.</span><span class="n">sum</span> <span class="o">+</span> <span class="n">rc</span><span class="p">.</span><span class="n">sum</span><span class="p">};</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">Node</span> <span class="o">:</span> <span class="n">Seg</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">lc</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">ll</span> <span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">SegmentTree</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="n">build</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="n">build</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">({});</span>
		<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">Seg</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">({</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">});</span>
		<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span> <span class="o">=</span> <span class="n">NPOS</span><span class="p">;</span>
		<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="c1">//if (l &lt; r) //动态开点的时候注释掉本行和下一行
</span>		<span class="c1">//down(rt), v[rt].Seg::operator=(v[v[rt].lc] + v[v[rt].rc]);
</span>	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">down</span><span class="p">(</span><span class="kt">int</span> <span class="n">rt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">r</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span> <span class="o">==</span> <span class="n">NPOS</span><span class="p">)</span>
			<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">build</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="c1">//else //非可持久化的时候注释掉本行和下一行
</span>		<span class="c1">//v.push_back(v[v[rt].lc]), v[rt].lc = v.size() - 1;
</span>		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NPOS</span><span class="p">)</span>
			<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">build</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">r</span><span class="p">);</span>
		<span class="c1">//else //非可持久化的时候注释掉本行和下一行
</span>		<span class="c1">//v.push_back(v[v[rt].rc]), v[rt].rc = v.size() - 1;
</span>		<span class="n">upd</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">mul</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">);</span>
		<span class="n">upd</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">mul</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">upd</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">ll</span> <span class="n">mul</span><span class="p">,</span> <span class="n">ll</span> <span class="n">add</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">mul</span> <span class="o">*=</span> <span class="n">mul</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">add</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">add</span> <span class="o">*</span> <span class="n">mul</span> <span class="o">+</span> <span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">upd</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
		<span class="n">down</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
			<span class="n">upd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
			<span class="n">upd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">upd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">),</span> <span class="n">upd</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">Seg</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">Seg</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">];</span>
		<span class="n">down</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ask</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ask</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ask</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">].</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">lc</span><span class="p">)</span> <span class="o">+</span> <span class="n">ask</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">rt</span><span class="p">].</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="无旋treap">无旋Treap</h2>

<h3 id="按子树大小分裂">按子树大小分裂</h3>

<p><a href="https://vjudge.net/solution/18405379">使用示例</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">FhqTreap</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Node</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">siz</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>
		<span class="n">ll</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">add</span><span class="p">;</span>
		<span class="kt">void</span> <span class="nf">upd</span><span class="p">(</span><span class="n">ll</span> <span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">val</span> <span class="o">+=</span> <span class="n">v</span><span class="p">,</span> <span class="n">min</span> <span class="o">+=</span> <span class="n">v</span><span class="p">,</span> <span class="n">add</span> <span class="o">+=</span> <span class="n">v</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">swap</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">FhqTreap</span><span class="p">()</span> <span class="o">:</span> <span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">root</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">down</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">k</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">ch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">v</span><span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">upd</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">add</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">rev</span><span class="p">);</span>
		<span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">add</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">up</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">k</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">siz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">min</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">ch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">siz</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">siz</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">min</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">min</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">int</span> <span class="n">merge</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span> <span class="o">||</span> <span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">down</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">),</span> <span class="n">up</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">down</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">up</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">split</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">siz</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span>
			<span class="n">down</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">siz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">),</span> <span class="n">up</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">down</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">up</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">a</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">push_back</span><span class="p">(</span><span class="n">ll</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span> <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Node</span><span class="p">{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rand</span><span class="p">(),</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">}),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="n">insert</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">ll</span> <span class="n">d</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Node</span><span class="p">{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rand</span><span class="p">(),</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">});</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">erase</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">Node</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">Node</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">upd</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">ll</span> <span class="n">add</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">upd</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">rev</span><span class="p">),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">revolve</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">d</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">merge</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="按值大小分裂">按值大小分裂</h3>

<p><a href="https://vjudge.net/solution/18405431">使用示例</a>，即排序树。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">FhqTreap</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Node</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">siz</span><span class="p">;</span>
		<span class="n">ll</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">FhqTreap</span><span class="p">()</span> <span class="o">:</span> <span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">root</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">up</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">siz</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">siz</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]].</span><span class="n">siz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
	<span class="kt">int</span> <span class="n">merge</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span> <span class="o">||</span> <span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">),</span> <span class="n">up</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">up</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">splitVal</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">ll</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="c1">//按值将树划分，使得左子树上的值恰小于w
</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">)</span>
			<span class="n">splitVal</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">up</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">splitVal</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">),</span> <span class="n">up</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">a</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">insert</span><span class="p">(</span><span class="n">ll</span> <span class="n">x</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
		<span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Node</span><span class="p">{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rand</span><span class="p">(),</span> <span class="n">x</span><span class="p">}),</span> <span class="n">splitVal</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">erase</span><span class="p">(</span><span class="n">ll</span> <span class="n">x</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">splitVal</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">splitVal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ll</span> <span class="n">kth</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">root</span><span class="p">,</span> <span class="n">ls</span><span class="p">;;)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ls</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">siz</span><span class="p">,</span> <span class="n">ls</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ls</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">)</span>
				<span class="n">k</span> <span class="o">-=</span> <span class="n">ls</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="kt">int</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">ll</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">upper_bound</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
	<span class="kt">int</span> <span class="n">upper_bound</span><span class="p">(</span><span class="n">ll</span> <span class="n">x</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">splitVal</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">siz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="莫队">莫队</h2>

<p><a href="https://vjudge.net/solution/14265915">使用示例</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Mo</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Query</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
		<span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Query</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="k">const</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">!=</span> <span class="n">n</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">?</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">l</span> <span class="o">:</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Query</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>
	<span class="kt">void</span> <span class="nf">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="n">q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Query</span><span class="p">{</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="nf">rev</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="nf">cal</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="nf">ask</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">q</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">L</span><span class="o">++</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="o">--</span><span class="n">L</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="o">++</span><span class="n">R</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">R</span><span class="o">--</span><span class="p">);</span>
			<span class="n">cal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="带修莫队">带修莫队</h3>

<p><a href="https://vjudge.net/solution/14269038">使用示例</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Mo</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Update</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">NEW</span><span class="p">,</span> <span class="n">OLD</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">Query</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
		<span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Query</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="k">const</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">!=</span> <span class="n">n</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">?</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">l</span> <span class="o">:</span> <span class="n">r</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">!=</span> <span class="n">n</span><span class="p">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">?</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">r</span> <span class="o">:</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Update</span><span class="o">&gt;</span> <span class="n">cq</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Query</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>
	<span class="n">Mo</span><span class="p">()</span> <span class="o">:</span> <span class="n">cq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="n">q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Query</span><span class="p">{</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="n">cq</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Update</span><span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]}),</span> <span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="p">}</span>
	<span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">rev</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">rev</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">rev</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">cal</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">ask</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">T</span> <span class="o">=</span> <span class="n">L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">q</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">T</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span>
				<span class="o">++</span><span class="n">T</span><span class="p">,</span> <span class="n">set</span><span class="p">(</span><span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span> <span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">NEW</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">T</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span>
				<span class="n">set</span><span class="p">(</span><span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span> <span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">OLD</span><span class="p">),</span> <span class="o">--</span><span class="n">T</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">L</span><span class="o">++</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="o">--</span><span class="n">L</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="o">++</span><span class="n">R</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">R</span><span class="o">--</span><span class="p">);</span>
			<span class="n">cal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="树上莫队">树上莫队</h3>

<p><a href="https://vjudge.net/solution/14284324">使用示例</a></p>

<p>按照欧拉序分块，使用Tarjan在生成欧拉序的同时预处理所有询问的lca，预处理时间复杂度$O(n+q)$。
h为查询图，即如果有一个询问(u,v)，即在h上连$u\to v,v\to u$。多个询问边有序插入h。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">TreeMo</span> <span class="o">:</span> <span class="n">Graph</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Query</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">lca</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
		<span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Query</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="k">const</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">?</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span> <span class="o">:</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Query</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">dfi</span><span class="p">,</span> <span class="n">dfo</span><span class="p">;</span>
	<span class="n">UnionFindSet</span> <span class="n">ufs</span><span class="p">;</span>
	<span class="n">Graph</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>
	<span class="n">TreeMo</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">Graph</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">h</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dfp</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dfi</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dfo</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">ufs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">h</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Edge</span><span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">}),</span> <span class="n">h</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Edge</span><span class="p">{</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">});</span>
		<span class="n">q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Query</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">rev</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">cal</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dfp</span><span class="p">[</span><span class="n">dfi</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">to</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">second</span><span class="p">,</span> <span class="o">!</span><span class="n">dfi</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>
				<span class="n">dfs</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">cnt</span><span class="p">),</span> <span class="n">ufs</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
		<span class="n">dfp</span><span class="p">[</span><span class="n">dfo</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">id</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">second</span><span class="p">,</span> <span class="n">dfo</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">lca</span> <span class="o">=</span> <span class="n">ufs</span><span class="p">.</span><span class="n">fa</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
				<span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">lca</span> <span class="o">!=</span> <span class="n">u</span> <span class="o">?</span> <span class="n">dfo</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">:</span> <span class="n">dfi</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>
				<span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">dfi</span><span class="p">[</span><span class="n">to</span><span class="p">];</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">root</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dfs</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">BS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">BS</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">BS</span><span class="p">);</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">q</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
		<span class="n">L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="n">L</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="o">--</span><span class="n">L</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="o">++</span><span class="n">R</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="n">R</span><span class="o">--</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span> <span class="o">!=</span> <span class="n">dfp</span><span class="p">[</span><span class="n">L</span><span class="p">])</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span><span class="p">);</span>
			<span class="n">cal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span> <span class="o">!=</span> <span class="n">dfp</span><span class="p">[</span><span class="n">L</span><span class="p">])</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="树上带修莫队">树上带修莫队</h3>

<p><a href="https://vjudge.net/solution/14269069">使用示例</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">CapitalTreeMo</span> <span class="o">:</span> <span class="n">Graph</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Update</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">NEW</span><span class="p">,</span> <span class="n">OLD</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">Query</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">lca</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
		<span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Query</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="k">const</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">?</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span> <span class="o">:</span> <span class="n">r</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">BS</span> <span class="o">?</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">r</span> <span class="o">:</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">t</span><span class="p">;</span> <span class="c1">//在BZOJ4129上去掉r/BS还快100ms?
</span>		<span class="p">}</span>
	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Update</span><span class="o">&gt;</span> <span class="n">cq</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Query</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">dfp</span><span class="p">,</span> <span class="n">dfi</span><span class="p">,</span> <span class="n">dfo</span><span class="p">;</span>
	<span class="n">UnionFindSet</span> <span class="n">ufs</span><span class="p">;</span>
	<span class="n">Graph</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>
	<span class="n">CapitalTreeMo</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">cq</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Graph</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">h</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dfp</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dfi</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dfo</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">ufs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">h</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Edge</span><span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">}),</span> <span class="n">h</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Edge</span><span class="p">{</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">});</span>
		<span class="n">q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Query</span><span class="p">{</span><span class="n">cq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cq</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Update</span><span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]}),</span> <span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dfp</span><span class="p">[</span><span class="n">dfi</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">to</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">second</span><span class="p">,</span> <span class="o">!</span><span class="n">dfi</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>
				<span class="n">dfs</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">cnt</span><span class="p">),</span> <span class="n">ufs</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
		<span class="n">dfp</span><span class="p">[</span><span class="n">dfo</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="o">++</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">id</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">second</span><span class="p">,</span> <span class="n">dfo</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">lca</span> <span class="o">=</span> <span class="n">ufs</span><span class="p">.</span><span class="n">fa</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
				<span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">lca</span> <span class="o">!=</span> <span class="n">u</span> <span class="o">?</span> <span class="n">dfo</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">:</span> <span class="n">dfi</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>
				<span class="n">q</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">dfi</span><span class="p">[</span><span class="n">to</span><span class="p">];</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">rev</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">rev</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
		<span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">rev</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">cal</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">root</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dfs</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">BS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">BS</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">BS</span><span class="p">);</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">q</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
		<span class="n">T</span> <span class="o">=</span> <span class="n">L</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">T</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span>
				<span class="o">++</span><span class="n">T</span><span class="p">,</span> <span class="n">set</span><span class="p">(</span><span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span> <span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">NEW</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">T</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span><span class="p">)</span>
				<span class="n">set</span><span class="p">(</span><span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span> <span class="n">cq</span><span class="p">[</span><span class="n">T</span><span class="p">].</span><span class="n">OLD</span><span class="p">),</span> <span class="o">--</span><span class="n">T</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="n">L</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="o">--</span><span class="n">L</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="o">++</span><span class="n">R</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">)</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="n">R</span><span class="o">--</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span> <span class="o">!=</span> <span class="n">dfp</span><span class="p">[</span><span class="n">L</span><span class="p">])</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span><span class="p">);</span>
			<span class="n">cal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span> <span class="o">!=</span> <span class="n">dfp</span><span class="p">[</span><span class="n">L</span><span class="p">])</span>
				<span class="n">rev</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lca</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="字符串模式匹配">字符串/模式匹配</h2>

<h3 id="hashstring">HashString</h3>

<p><a href="https://vjudge.net/solution/18293901">使用示例</a>，如果要修改模数或者直接使用<code class="highlighter-rouge">unsigned long long</code>的自然溢出的话直接修改Mod即可。</p>

<p>使用<code class="highlighter-rouge">unsigned long long</code>的自然溢出<a href="https://vjudge.net/solution/18293930">快了5倍</a>，但是容易被卡。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">HashString</span> <span class="o">:</span> <span class="n">Mod</span>
<span class="p">{</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">ll</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">HashString</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">ll</span> <span class="n">M</span> <span class="o">=</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ll</span> <span class="n">P</span> <span class="o">=</span> <span class="mi">131</span><span class="p">)</span> <span class="o">:</span> <span class="n">Mod</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">f</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">f</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">mul</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">P</span><span class="p">),</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">P</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ll</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">],</span> <span class="o">-</span><span class="n">mul</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">len</span><span class="p">]));</span> <span class="p">}</span> <span class="c1">//从pos位置开始的长度为len的子串的hash值
</span><span class="p">};</span>
</code></pre></div></div>

<h3 id="kmp">KMP</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">KMP</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">string</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">KMP</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">s</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">next</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">next</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">];)</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">next</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">next</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">?</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="kt">bool</span> <span class="n">find_in</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">next</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="o">++</span><span class="n">j</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//不return可得到t中s的所有匹配地址i+1-s.size()
</span>		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="ac自动机">AC自动机</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">AhoCorasick</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Node</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
		<span class="kt">int</span> <span class="o">&amp;</span><span class="n">to</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">ch</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">];</span>
		<span class="p">}</span> <span class="c1">//如果不确定c的范围，使用map
</span>	<span class="p">};</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">AhoCorasick</span><span class="p">()</span> <span class="o">:</span> <span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
	<span class="kt">void</span> <span class="n">getFail</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">deque</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span> <span class="o">!</span><span class="n">q</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span> <span class="n">q</span><span class="p">.</span><span class="n">pop_front</span><span class="p">())</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">front</span><span class="p">(),</span> <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">f</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">u</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
					<span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">f</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">v</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">w</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">q</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">v</span><span class="p">[</span><span class="n">w</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
					<span class="n">w</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">w</span><span class="p">].</span><span class="n">f</span><span class="p">;</span>
				<span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">f</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">w</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
				<span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">f</span><span class="p">].</span><span class="n">val</span> <span class="o">?</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">f</span> <span class="o">:</span> <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">f</span><span class="p">].</span><span class="n">last</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]))</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="p">{</span>
				<span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
				<span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Node</span><span class="p">());</span>
			<span class="p">}</span>
		<span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">bool</span> <span class="n">find_in</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//调用需要调用`getFail()`生成失配函数。
</span>	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				<span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">val</span> <span class="o">||</span> <span class="n">v</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">last</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="暴力回文">暴力回文</h3>

<p><a href="https://vjudge.net/solution/14387201">使用示例</a></p>

<p>时间复杂度$O(n^2)$，常数低，但会被<code class="highlighter-rouge">ababababa</code>这样的数据卡。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">palindrome</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];)</span>
			<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="n">e</span><span class="p">];)</span>
			<span class="o">--</span><span class="n">b</span><span class="p">,</span> <span class="o">++</span><span class="n">e</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ans</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
			<span class="n">ans</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> <span class="c1">//此时[b,e)为最大回文区间
</span>	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="线性回文">线性回文</h3>

<p><a href="https://vjudge.net/solution/14387164">使用示例</a></p>

<p>对于一个位置i，[i−f[i]+1,i+f[i]−1]是最长的以i为中心的奇回文串，g[i]−i是最长的以i为开头的回文串长度。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Manacher</span>
<span class="p">{</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
	<span class="n">Manacher</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">t</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">g</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1">//t初始值为s中没有出现过的值，g开始为0
</span>	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">?</span> <span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="n">i</span><span class="p">],</span> <span class="n">m</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
				 <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
				 <span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]];)</span>
				<span class="o">++</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="n">p</span> <span class="o">=</span> <span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">g</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				<span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="kt">int</span> <span class="n">ask</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="c1">//多次询问可做一个ST表
</span>	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ans</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">ans</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="回文自动机">回文自动机</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define maxn 2000006
#define lx 26 //如果是字符串的内容是数字，则改为10
</span><span class="k">struct</span> <span class="n">Pam</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Node</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">[</span><span class="n">lx</span><span class="p">],</span> <span class="n">fail</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">b</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="n">maxn</span><span class="p">];</span>
	<span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">int</span> <span class="nf">get_fail</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">fail</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">insert</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">get_fail</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]])</span>
		<span class="p">{</span>
			<span class="n">b</span><span class="p">[</span><span class="o">++</span><span class="n">cnt</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">get_fail</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">fail</span><span class="p">);</span>
			<span class="n">b</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">fail</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]];</span>
			<span class="n">b</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">fail</span><span class="p">].</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">b</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ch</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]];</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">solve</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">;</span>
			<span class="n">insert</span><span class="p">();</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">last</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">last</span><span class="p">].</span><span class="n">num</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="后缀数组">后缀数组</h3>

<p><a href="https://vjudge.net/solution/14316681">使用示例</a></p>

<p>m：字符集大小。</p>

<p>s：字符串，其中最后一位为加入的0。</p>

<p>sa[i]：字典序第i小的是哪个后缀。</p>

<p>rk[i]：后缀i的排名。</p>

<p>h[i]：lcp(sa[i],sa[i−1])。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">SufArr</span>
<span class="p">{</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sa</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">SufArr</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">)</span> <span class="o">:</span> <span class="n">sa</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rk</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">h</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">cnt</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="o">++</span><span class="n">cnt</span><span class="p">[</span><span class="n">rk</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">sa</span><span class="p">[</span><span class="o">--</span><span class="n">cnt</span><span class="p">[</span><span class="n">rk</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">j</span> <span class="o">+=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
				<span class="n">h</span><span class="p">[</span><span class="n">cnt</span><span class="p">[</span><span class="n">rk</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rk</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">rk</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">||</span> <span class="n">rk</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rk</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">])</span>
					<span class="n">cnt</span><span class="p">[</span><span class="o">++</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">sa</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">swap</span><span class="p">(</span><span class="n">rk</span><span class="p">,</span> <span class="n">sa</span><span class="p">),</span> <span class="n">swap</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rk</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="o">~</span><span class="n">k</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">];</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rk</span><span class="p">[</span><span class="n">sa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">--</span><span class="n">k</span><span class="p">)</span>
				<span class="n">h</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

  </div>
  
  
  <div class="reward">
    <button id="rewardButton" disable="enable"
      onclick="var qr = document.getElementById('rewardQRs'); qr.style.display = (qr.style.display === 'block') ? 'none' : 'block';">
      如果我的博客帮助到你，可以请我喝一杯咖啡~
    </button>
    <div id="rewardQRs">
      <table>
        <tr>
          
          <td id="wechat" class="reward_qr">
            <img id="wechat_qr" src="/public/image/wechatpay.jpg" alt="WuKwechat">
          </td>
          
          <td id="alipay" class="reward_qr">
            <img id="alipay_qr" src="/public/image/alipay.jpg" alt="WuKalipay">
          </td>
          
        </tr>
      </table>
    </div>
  </div>
  
</div>


<script src="/public/js/valine.js"></script>


    </div>
  </div>
  <label for="sidebar-checkbox" class="sidebar-toggle fas fa-bars"></label>
</body>

</html>
