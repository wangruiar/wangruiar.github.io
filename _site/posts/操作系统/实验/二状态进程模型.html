<h1 id="实验题目">实验题目</h1>
<p>二状态进程模型</p>
<h1 id="实验目的">实验目的</h1>
<ol>
  <li>学习进程模型知识，掌握进程模型的实现方法。</li>
  <li>利用时钟中断，设计时钟中断处理进行进程交替执行</li>
  <li>扩展MyOS，实现多进程模型的原型操作系统。</li>
</ol>

<h1 id="实验内容">实验内容</h1>
<p>在实验五的基础上，进化你的原型操作系统，原型保留原有特征的基础上，设计满足下列要求的新原型操作系统：</p>
<ol>
  <li>内核实现简单进程模型，进程具有就绪、运行两种基本状态。建议在c程序中定义进程表，进程数量最多4个。</li>
  <li>内核可以一次性加载最多4个用户程序。用户进程采用时间片轮转调度进程。由你设计有个性的用户程序，它们的输出各占1/4屏幕区域，信息输出有动感，以便观察程序是否在执行。</li>
  <li>在原型中保证原有的系统调用服务可用。再编写4个用户程序，展示系统调用服务还能工作。</li>
</ol>

<h1 id="实验方案">实验方案</h1>
<h2 id="实验环境">实验环境</h2>
<h3 id="软件">软件</h3>
<ul>
  <li>Windows 10, 64-bit  (Build 17763) 10.0.17763</li>
  <li>Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]：WSL是以软件的形式运行在Windows下的Linux子系统，是近些年微软推出来的新工具，可以在Windows系统上原生运行Linux。</li>
  <li>gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)：C语言程序编译器，Ubuntu自带。</li>
  <li>NASM version 2.13.02：汇编程序编译器，通过<code class="highlighter-rouge">sudo apt install nasm</code>安装在WSL上。</li>
  <li>Oracle VM VirtualBox 6.0.6 r130049 (Qt5.6.2)：轻量开源的虚拟机软件。</li>
  <li>VSCode - Insiders v1.33.0：好用的文本编辑器，有丰富的插件。</li>
  <li>hexdump for VSCode 1.7.2: VSCode中一个好用的十六进制显示插件。</li>
  <li>GNU Make 4.1：安装在Ubuntu下，一键编译并连接代码，生成最终的文件。</li>
</ul>

<p>大部分开发环境安装在WSL上，较之于双系统、虚拟机等其他开发方案，更加方便，也方便直接使用Linux下的一些指令。</p>
<h3 id="硬件">硬件</h3>
<h4 id="开发环境配置">开发环境配置</h4>
<p>所用机器型号为VAIO Z Flip 2016</p>
<ul>
  <li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
  <li>8.00GB RAM</li>
</ul>

<h4 id="虚拟机配置">虚拟机配置</h4>
<ul>
  <li>处理器内核总数：1</li>
  <li>RAM：4MB</li>
</ul>

<h2 id="实验原理">实验原理</h2>
<p>时钟中断响应后，保存当前进程A的寄存器状态；寻找下一个进程B ；还原进程B的寄存器状态。</p>
<h3 id="设计进程控制块和schedule过程">设计进程控制块和<code class="highlighter-rouge">schedule</code>过程</h3>
<p>首先要明确：需要保存多少个寄存器。</p>
<blockquote>
  <p>8086 计算机有以下寄存器：</p>
  <ul>
    <li>指令指针寄存器：ip</li>
    <li>段寄存器：cs, es, ds, ss</li>
    <li>主寄存器：di, si, bp, sp, ax, bx, cx, dx</li>
    <li>标志寄存器</li>
  </ul>
</blockquote>

<p>我使用如下的C语言代码来作为进程控制和调度的过程：</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SCHEDULE_QUEUE_LEN 9
#define NEW 0
#define RUNNING 1
</span><span class="k">struct</span> <span class="n">PCB</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ip</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">q</span><span class="p">[</span><span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">qb</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">qe</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">statues</span><span class="p">[</span><span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">NEW</span><span class="p">},</span> <span class="n">pidStack</span><span class="p">[</span><span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">pidStack</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">schedule</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">do</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qb</span> <span class="o">==</span> <span class="n">q</span> <span class="o">+</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">)</span>
			<span class="n">qb</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">statues</span><span class="p">[</span><span class="n">qb</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RUNNING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qe</span> <span class="o">==</span> <span class="n">q</span> <span class="o">+</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">)</span>
		<span class="n">qe</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>在老师给我们的原型中是为每个程序创建一张表，这样做的缺点有两个：一个是每个程序至多只能同时运行一个；另一个是在调度时如果只加载了少数进程，也仍然需要遍历检查所有的程序，会拖慢操作系统运行的速度。因此我在这里实现了一个循环队列，每次保存进程时写入队尾，进程恢复时从队首取一个“有效”的进程块即可。所谓“有效”将在下面“关闭进程”中解释。</p>

<p>这里使用0号pid代表内核进程。</p>
<h3 id="创建进程">创建进程</h3>
<p>首先创建进程控制块，将<code class="highlighter-rouge">cs</code>,<code class="highlighter-rouge">ds</code>等寄存器设置为合适的值，然后设置该进程为“就绪”状态。考虑到进程结束后应返回内核并将该进程的<code class="highlighter-rouge">statues</code>属性设置为<code class="highlighter-rouge">NEW</code>，操作系统应事先在其用户栈内写入返回<code class="highlighter-rouge">cs</code>和返回<code class="highlighter-rouge">ip</code>。用户程序返回内核后，将<code class="highlighter-rouge">alive</code>属性设置为0，死循环等待时钟中断发生。时钟中断发生后，该进程结束，下一次时间片轮转将不再轮到它。</p>

<p>我实现了一个栈用来分配当前进程的pid，即当前进程的标识。这样做的好处和上面使用循环队列的好处一样，可以减少分配时候的空转问题。此外，当栈为空的时候，我的操作系统可以重新分配pid，从而实现杀进程的效果，防止进程资源被用户程序过多占用而不能新开进程。当然，0号pid代表操作系统内核，因此不会被重新分配。</p>
<h3 id="关闭进程">关闭进程</h3>
<p>我这里使用了伪关闭的方法，不是直接将进程的控制块移出队列，而是先在状态表中将其置为关闭，等待调度程序来判断当前进程队列首的进程是否已被关闭，如果是的话直接出队检查下一个进程，直到找到一个有效的进程。由于内核进程是不可以被杀死的，因此进程队列永远不为空。</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">statues</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">NEW</span><span class="p">,</span> <span class="o">*++</span><span class="n">top</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</code></pre></div></div>
<p>关闭进程时将其<code class="highlighter-rouge">pid</code>重新压回栈中，供下一次创建进程时分配。</p>

<p>当然，在当前版本的内核中检测键盘中断没有用多进程实现，因此在多进程运行的时候实际上是没有办法退回到内核的，也就是说这个关闭进程的功能虽然实现是正确的，但是暂时没办法去测试。等待后续版本实现多进程响应键盘中断之后吧。</p>
<h3 id="save和restart过程"><code class="highlighter-rouge">save</code>和<code class="highlighter-rouge">restart</code>过程</h3>
<p>中断发生时，由CPU将标志寄存器<code class="highlighter-rouge">flags</code>、代码段寄存器<code class="highlighter-rouge">cs</code>、指令指针寄存器<code class="highlighter-rouge">ip</code>依次压入堆栈（被中断的程序的堆栈）；中断返回时（即执行<code class="highlighter-rouge">iret</code>指令时），CPU将堆栈中的指令指针寄存器<code class="highlighter-rouge">ip</code>、代码段寄存器<code class="highlighter-rouge">cs</code>、标志寄存器<code class="highlighter-rouge">flags</code>依次弹出堆栈，并转到<code class="highlighter-rouge">CS:IP</code>继续原程序的执行。照着文档，我读懂了老师提供的“现场保护”：<code class="highlighter-rouge">save</code>过程（旧版）代码和现场恢复<code class="highlighter-rouge">restart</code>过 程（旧版）代码。我计划<code class="highlighter-rouge">schedule</code>过程由C 实现，故<code class="highlighter-rouge">save</code>过程只需将寄存器保存在外部变量（C语言的变量）， 然后<code class="highlighter-rouge">restore</code>过程需要将外部变量还原到寄存器中。如此安排，<code class="highlighter-rouge">schedule</code>过程要做的事情是：将C语言的变量保存到A进程控制块中，然后调度另一进程B，将<code class="highlighter-rouge">B</code>进程控制块中的寄存器写入C语言的变量。</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">call</span> <span class="n">save</span>
	<span class="k">pusha</span>
	<span class="k">push</span> <span class="n">ds</span>
	<span class="k">push</span> <span class="n">es</span>

	<span class="k">push</span> <span class="mi">0</span>
	<span class="k">call</span> <span class="n">schedule</span>
<span class="n">restart</span><span class="o">:</span>
	<span class="k">pop</span> <span class="n">es</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">popa</span>

	<span class="k">mov</span> <span class="n">si</span><span class="p">,[qb]</span>
	<span class="k">mov</span> <span class="n">es</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span><span class="c">;es</span>
	<span class="k">mov</span> <span class="n">ss</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">20</span><span class="err">]</span><span class="c">;ss</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">24</span><span class="err">]</span><span class="c">;ax</span>
	<span class="k">mov</span> <span class="n">bx</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">28</span><span class="err">]</span><span class="c">;bx</span>
	<span class="k">mov</span> <span class="n">cx</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">32</span><span class="err">]</span><span class="c">;cx</span>
	<span class="k">mov</span> <span class="n">dx</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">36</span><span class="err">]</span><span class="c">;dx</span>
	<span class="k">mov</span> <span class="n">di</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">40</span><span class="err">]</span><span class="c">;di</span>
	<span class="k">mov</span> <span class="n">bp</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">44</span><span class="err">]</span><span class="c">;bp</span>
	<span class="k">mov</span> <span class="n">sp</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">48</span><span class="err">]</span><span class="c">;sp</span>

	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="p">[si]</span>

	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">52</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">16</span><span class="err">]</span><span class="c">;ds</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">pop</span> <span class="n">si</span>

	<span class="k">push</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">al</span><span class="p">,</span><span class="mi">20</span><span class="n">h</span>
	<span class="k">out</span> <span class="mi">20</span><span class="n">h</span><span class="p">,</span><span class="n">al</span>
	<span class="k">out</span> <span class="mi">0</span><span class="n">A0h</span><span class="p">,</span><span class="n">al</span>
	<span class="k">pop</span> <span class="n">ax</span>
	<span class="k">iret</span>
<span class="n">save</span><span class="o">:</span>
	<span class="k">push</span> <span class="n">ds</span>
	<span class="k">push</span> <span class="n">cs</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">save_ds</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">save_cs</span><span class="err">]</span>

	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">save_si</span><span class="err">]</span><span class="p">,</span><span class="n">si</span>
	<span class="k">mov</span> <span class="n">si</span><span class="p">,</span><span class="n">word</span><span class="p">[qe]</span>

	<span class="k">pop</span> <span class="n">word</span> <span class="p">[si]</span>
	<span class="k">pop</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>

	<span class="k">mov</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span><span class="p">,</span><span class="n">es</span>
	<span class="k">push</span> <span class="n">word</span> <span class="err">[</span><span class="n">save_ds</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">16</span><span class="err">]</span>

	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">20</span><span class="err">]</span><span class="p">,</span><span class="n">ss</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">24</span><span class="err">]</span><span class="p">,</span><span class="n">ax</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">28</span><span class="err">]</span><span class="p">,</span><span class="n">bx</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">32</span><span class="err">]</span><span class="p">,</span><span class="n">cx</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">36</span><span class="err">]</span><span class="p">,</span><span class="n">dx</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">40</span><span class="err">]</span><span class="p">,</span><span class="n">di</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">44</span><span class="err">]</span><span class="p">,</span><span class="n">bp</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">48</span><span class="err">]</span><span class="p">,</span><span class="n">sp</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">save_pid</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">save_si</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">52</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">56</span><span class="err">]</span>
	<span class="k">jmp</span> <span class="n">word</span><span class="err">[</span><span class="n">save_cs</span><span class="err">]</span>
</code></pre></div></div>
<p>这里保存变量直接保存在C代码中的队尾<code class="highlighter-rouge">qe</code>，并在调度后从C代码中的队首<code class="highlighter-rouge">qb</code>中取出变量恢复即可。</p>
<h1 id="实验过程">实验过程</h1>
<h2 id="实验代码">实验代码</h2>
<h3 id="bootloaderasm">bootloader.asm</h3>
<p>和<a href="https://wu-kan.github.io/posts/操作系统/实验/系统调用">上一个实验</a>中的代码完全相同，不再放出。</p>
<h3 id="kernelasm">kernel.asm</h3>
<p>实现系统中断和时钟中断。</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">%macro</span> <span class="n">setIVT</span> <span class="mi">2</span>
	<span class="k">push</span> <span class="n">es</span>
	<span class="k">push</span> <span class="n">ds</span>
	<span class="k">push</span> <span class="n">si</span>
	<span class="k">pusha</span>
	<span class="k">xor</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">es</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="kr">%1</span>
	<span class="k">mov</span> <span class="n">bx</span><span class="p">,</span> <span class="mi">4</span>
	<span class="k">mul</span> <span class="n">bx</span>
	<span class="k">mov</span> <span class="n">si</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="kr">%2</span>
	<span class="k">mov</span> <span class="err">[</span><span class="n">es</span><span class="o">:</span><span class="n">si</span><span class="err">]</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">add</span> <span class="n">si</span><span class="p">,</span> <span class="mi">2</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cs</span>
	<span class="k">mov</span> <span class="err">[</span><span class="n">es</span><span class="o">:</span><span class="n">si</span><span class="err">]</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">popa</span>
	<span class="k">pop</span> <span class="n">si</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">pop</span> <span class="n">es</span>
<span class="cp">%endmacro</span>
	<span class="n">bits</span> <span class="mi">16</span>
	<span class="kr">extern</span> <span class="n">qb</span><span class="p">,</span><span class="n">qe</span><span class="p">,</span><span class="n">schedule</span><span class="p">,</span><span class="n">terminal</span><span class="p">,</span><span class="n">prgCall</span>
	<span class="kr">global</span> <span class="n">_start</span>
<span class="n">_start</span><span class="o">:</span>
	<span class="n">setIVT</span> <span class="mi">33</span><span class="p">,</span><span class="n">int33</span>
	<span class="n">setIVT</span> <span class="mi">8</span><span class="p">,</span><span class="n">int8</span>
	<span class="k">push</span> <span class="mi">0</span>
	<span class="k">call</span> <span class="n">terminal</span>
	<span class="k">ret</span>
<span class="n">int8</span><span class="o">:</span>
	<span class="k">cli</span>
	<span class="k">call</span> <span class="n">save</span>
	<span class="k">pusha</span>
	<span class="k">push</span> <span class="n">ds</span>
	<span class="k">push</span> <span class="n">es</span>

	<span class="k">push</span> <span class="mi">0</span>
	<span class="k">call</span> <span class="n">schedule</span>
<span class="n">restart</span><span class="o">:</span>
	<span class="k">pop</span> <span class="n">es</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">popa</span>

	<span class="k">mov</span> <span class="n">si</span><span class="p">,[qb]</span>
	<span class="k">mov</span> <span class="n">es</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span><span class="c">;es</span>
	<span class="k">mov</span> <span class="n">ss</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">20</span><span class="err">]</span><span class="c">;ss</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">24</span><span class="err">]</span><span class="c">;ax</span>
	<span class="k">mov</span> <span class="n">bx</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">28</span><span class="err">]</span><span class="c">;bx</span>
	<span class="k">mov</span> <span class="n">cx</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">32</span><span class="err">]</span><span class="c">;cx</span>
	<span class="k">mov</span> <span class="n">dx</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">36</span><span class="err">]</span><span class="c">;dx</span>
	<span class="k">mov</span> <span class="n">di</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">40</span><span class="err">]</span><span class="c">;di</span>
	<span class="k">mov</span> <span class="n">bp</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">44</span><span class="err">]</span><span class="c">;bp</span>
	<span class="k">mov</span> <span class="n">sp</span><span class="p">,</span><span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">48</span><span class="err">]</span><span class="c">;sp</span>

	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="p">[si]</span>

	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">52</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">16</span><span class="err">]</span><span class="c">;ds</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">pop</span> <span class="n">si</span>

	<span class="k">push</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">al</span><span class="p">,</span><span class="mi">20</span><span class="n">h</span>
	<span class="k">out</span> <span class="mi">20</span><span class="n">h</span><span class="p">,</span><span class="n">al</span>
	<span class="k">out</span> <span class="mi">0</span><span class="n">A0h</span><span class="p">,</span><span class="n">al</span>
	<span class="k">pop</span> <span class="n">ax</span>
	<span class="k">sti</span>
	<span class="k">iret</span>
<span class="n">save</span><span class="o">:</span>
	<span class="k">push</span> <span class="n">ds</span>
	<span class="k">push</span> <span class="n">cs</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">save_ds</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">save_cs</span><span class="err">]</span>

	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">save_si</span><span class="err">]</span><span class="p">,</span><span class="n">si</span>
	<span class="k">mov</span> <span class="n">si</span><span class="p">,</span><span class="n">word</span><span class="p">[qe]</span>

	<span class="k">pop</span> <span class="n">word</span> <span class="p">[si]</span>
	<span class="k">pop</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>

	<span class="k">mov</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span><span class="p">,</span><span class="n">es</span>
	<span class="k">push</span> <span class="n">word</span> <span class="err">[</span><span class="n">save_ds</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span> <span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">16</span><span class="err">]</span>

	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">20</span><span class="err">]</span><span class="p">,</span><span class="n">ss</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">24</span><span class="err">]</span><span class="p">,</span><span class="n">ax</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">28</span><span class="err">]</span><span class="p">,</span><span class="n">bx</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">32</span><span class="err">]</span><span class="p">,</span><span class="n">cx</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">36</span><span class="err">]</span><span class="p">,</span><span class="n">dx</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">40</span><span class="err">]</span><span class="p">,</span><span class="n">di</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">44</span><span class="err">]</span><span class="p">,</span><span class="n">bp</span>
	<span class="k">mov</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">48</span><span class="err">]</span><span class="p">,</span><span class="n">sp</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">save_pid</span><span class="err">]</span>
	<span class="k">push</span> <span class="n">word</span><span class="err">[</span><span class="n">save_si</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">52</span><span class="err">]</span>
	<span class="k">pop</span> <span class="n">word</span><span class="err">[</span><span class="n">si</span><span class="o">+</span><span class="mi">56</span><span class="err">]</span>
	<span class="k">jmp</span> <span class="n">word</span><span class="err">[</span><span class="n">save_cs</span><span class="err">]</span>

<span class="n">int33</span><span class="o">:</span>
	<span class="k">cli</span>
	<span class="k">mov</span> <span class="n">al</span><span class="p">,</span><span class="n">ah</span>
	<span class="k">xor</span> <span class="n">ah</span><span class="p">,</span><span class="n">ah</span>
	<span class="k">push</span> <span class="n">eax</span>
	<span class="k">push</span> <span class="mi">0</span>
	<span class="k">call</span> <span class="n">prgCall</span>
	<span class="k">pop</span> <span class="n">eax</span>
	<span class="k">sti</span>
	<span class="k">iret</span>
<span class="n">datadef</span><span class="o">:</span>
	<span class="n">save_cs</span> <span class="n">dw</span> <span class="mi">0</span>
	<span class="n">save_si</span> <span class="n">dw</span> <span class="mi">0</span>
	<span class="n">save_ds</span> <span class="n">dw</span> <span class="mi">0</span>
	<span class="n">save_pid</span> <span class="n">dw</span> <span class="mi">0</span>
</code></pre></div></div>
<h2 id="kernerc">kerner.c</h2>
<p>实现二状态进程调度功能，前面已经解释过了。</p>

<p>此外，修复了滚屏的时候有时会出现灰屏的问题（忘记给<code class="highlighter-rouge">bh</code>寄存器赋值了）。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SCREEN_WIDTH 80
#define SCREEN_HEIGHT 25
#define BUF_LEN (SCREEN_WIDTH * SCREEN_HEIGHT)
#define PROGRAM_NUM 4
#define SCHEDULE_QUEUE_LEN 5
#define NEW 0
#define RUNNING 1
</span><span class="k">struct</span> <span class="n">PCB</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ip</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">q</span><span class="p">[</span><span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">qb</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">qe</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">statues</span><span class="p">[</span><span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">NEW</span><span class="p">},</span> <span class="n">pidStack</span><span class="p">[</span><span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">pidStack</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">schedule</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">do</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qb</span> <span class="o">==</span> <span class="n">q</span> <span class="o">+</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">)</span>
			<span class="n">qb</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">statues</span><span class="p">[</span><span class="n">qb</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RUNNING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qe</span> <span class="o">==</span> <span class="n">q</span> <span class="o">+</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">)</span>
		<span class="n">qe</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">const</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">address</span><span class="p">;</span>
<span class="p">}</span> <span class="n">prg</span><span class="p">[</span><span class="n">PROGRAM_NUM</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{{</span><span class="s">"prg1"</span><span class="p">,</span> <span class="s">"    156 bytes"</span><span class="p">,</span> <span class="s">"prg1"</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	 <span class="p">{</span><span class="s">"prg2"</span><span class="p">,</span> <span class="s">"    158 bytes"</span><span class="p">,</span> <span class="s">"prg2"</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	 <span class="p">{</span><span class="s">"prg3"</span><span class="p">,</span> <span class="s">"    168 bytes"</span><span class="p">,</span> <span class="s">"prg3"</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	 <span class="p">{</span><span class="s">"prg4"</span><span class="p">,</span> <span class="s">"    174 bytes"</span><span class="p">,</span> <span class="s">"prg4"</span><span class="p">,</span> <span class="mi">4</span><span class="p">}};</span>
<span class="kt">void</span> <span class="nf">loadProgram</span><span class="p">(</span><span class="kt">int</span> <span class="n">PrgSectorOffset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">UserPrgOffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"int 0x13"</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">1</span><span class="p">),</span> <span class="s">"b"</span><span class="p">(</span><span class="n">UserPrgOffset</span><span class="p">),</span> <span class="s">"c"</span><span class="p">(</span><span class="n">PrgSectorOffset</span><span class="p">),</span> <span class="s">"d"</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">call</span><span class="p">(</span><span class="kt">int</span> <span class="n">UserPrgOffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"call bx"</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">"b"</span><span class="p">(</span><span class="n">UserPrgOffset</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">prgCall</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loadProgram</span><span class="p">(</span><span class="n">prg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0a100</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mh">0x0a100</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">getCursor</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"int 0x10"</span>
		<span class="o">:</span> <span class="s">"=d"</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="mh">0x0300</span><span class="p">),</span> <span class="s">"b"</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">setCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"int 0x10"</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="mh">0x0200</span><span class="p">),</span> <span class="s">"b"</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">"d"</span><span class="p">(</span><span class="n">pos</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">pageUP</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"push bx</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"mov bh,0</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"int 0x10</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"pop bx</span><span class="se">\n</span><span class="s">"</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="mi">1536</span> <span class="o">+</span> <span class="n">p</span><span class="p">),</span> <span class="s">"c"</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">"d"</span><span class="p">(</span><span class="mh">0x184F</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">putC</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"int 0x10"</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">"a"</span><span class="p">(</span><span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">ch</span><span class="p">),</span> <span class="s">"b"</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="s">"c"</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">getch</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">"getch_loop:</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"mov ah, 0x01</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"int 0x16</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"jz getch_loop</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"mov ah, 0x00</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"int 0x16</span><span class="se">\n</span><span class="s">"</span>
		<span class="s">"xor ah, ah</span><span class="se">\n</span><span class="s">"</span>
		<span class="o">:</span> <span class="s">"=a"</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="o">:</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">getCursor</span><span class="p">(),</span> <span class="n">curX</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">curY</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="p">(</span><span class="n">curX</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">curX</span> <span class="o">&gt;=</span> <span class="n">SCREEN_HEIGHT</span><span class="p">)</span>
			<span class="o">--</span><span class="n">curX</span><span class="p">,</span> <span class="n">pageUP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">setCursor</span><span class="p">(</span><span class="n">curX</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">putC</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">curY</span> <span class="o">&gt;=</span> <span class="n">SCREEN_WIDTH</span><span class="p">)</span>
		<span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">setCursor</span><span class="p">(</span><span class="n">curX</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">curY</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">gets</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;;</span> <span class="o">++</span><span class="n">s</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">getch</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="o">++</span><span class="n">s</span><span class="p">)</span>
		<span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">strcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">s1</span> <span class="o">==</span> <span class="o">*</span><span class="n">s2</span><span class="p">))</span>
		<span class="o">++</span><span class="n">s1</span><span class="p">,</span> <span class="o">++</span><span class="n">s2</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">s1</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">s2</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">terminal</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">BUF_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="s">"$ "</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="n">gets</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span>
		<span class="o">*</span><span class="n">CLEAR_COM</span> <span class="o">=</span> <span class="s">"clear"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">HELP_COM</span> <span class="o">=</span> <span class="s">"help"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">EXEC_COM</span> <span class="o">=</span> <span class="s">"exec"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">EXECPRO_COM</span> <span class="o">=</span> <span class="s">"execpro"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">EXIT_COM</span> <span class="o">=</span> <span class="s">"exit"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">KILL_COM</span> <span class="o">=</span> <span class="s">"kill"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">LS_COM</span> <span class="o">=</span> <span class="s">"ls"</span><span class="p">,</span>
		<span class="o">*</span><span class="n">PS_COM</span> <span class="o">=</span> <span class="s">"ps"</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">CLEAR_COM</span><span class="p">))</span>
		<span class="n">pageUP</span><span class="p">(</span><span class="n">SCREEN_HEIGHT</span><span class="p">),</span> <span class="n">setCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">HELP_COM</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span>
			<span class="o">*</span><span class="n">HELP_INFO</span> <span class="o">=</span>
				<span class="s">"WuK-shell v0.0.3</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"These shell commands are defined internally.</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"Command         Description</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"clear        -- Clean the screen</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"help         -- Show this list</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"exec         -- Execute all the user programs</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"execpro      -- Execute all the user programs by mutiprocess</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"exit         -- Exit OS</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"kill         -- kill process</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"ls           -- Show existing programs</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"prg[num]     -- Execute the num-th program</span><span class="se">\n</span><span class="s">"</span>
				<span class="s">"ps           -- Show running programs with their pid</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">HELP_INFO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">EXEC_COM</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROGRAM_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">prgCall</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">EXECPRO_COM</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROGRAM_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">==</span> <span class="n">pidStack</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
					<span class="o">*++</span><span class="n">top</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">qe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="n">qe</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
			<span class="n">qe</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">qe</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">es</span> <span class="o">=</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">ds</span> <span class="o">=</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="mh">0xa100</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">;</span>

			<span class="n">loadProgram</span><span class="p">(</span><span class="n">prg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0a100</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">);</span>
			<span class="n">statues</span><span class="p">[</span><span class="n">qe</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">top</span><span class="o">--</span><span class="p">)]</span> <span class="o">=</span> <span class="n">RUNNING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qe</span> <span class="o">==</span> <span class="n">q</span> <span class="o">+</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">)</span>
				<span class="n">qe</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">EXIT_COM</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">pageUP</span><span class="p">(</span><span class="n">SCREEN_HEIGHT</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">KILL_COM</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">INFO</span> <span class="o">=</span> <span class="s">"Input the pid to kill: "</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">INFO</span><span class="p">);</span>
		<span class="n">gets</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">INFO</span> <span class="o">=</span> <span class="s">"Can not kill process 0.</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">INFO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="n">SCHEDULE_QUEUE_LEN</span> <span class="o">||</span> <span class="n">statues</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RUNNING</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">INFO</span> <span class="o">=</span> <span class="s">"Invalid pid.</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">INFO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">statues</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">NEW</span><span class="p">,</span> <span class="o">*++</span><span class="n">top</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">LS_COM</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROGRAM_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">prg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">),</span> <span class="n">printf</span><span class="p">(</span><span class="n">prg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">),</span> <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PS_COM</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span>
			<span class="o">*</span><span class="n">INFO</span> <span class="o">=</span> <span class="s">"pid statues</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
			<span class="o">*</span><span class="n">RUNNING_INFO</span> <span class="o">=</span> <span class="s">"   RUNNING</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
			<span class="o">*</span><span class="n">NEW_INFO</span> <span class="o">=</span> <span class="s">"   NEW</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">INFO</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCHEDULE_QUEUE_LEN</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">putchar</span><span class="p">(</span><span class="sc">'0'</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">statues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">RUNNING</span> <span class="o">?</span> <span class="n">RUNNING_INFO</span> <span class="o">:</span> <span class="n">NEW_INFO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">PROGRAM_NUM</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
				<span class="k">const</span> <span class="kt">char</span>
					<span class="o">*</span><span class="n">COMM_NOT_FOUND</span> <span class="o">=</span>
						<span class="s">" : command not found, type </span><span class="se">\'</span><span class="s">help</span><span class="se">\'</span><span class="s"> for available commands list.</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
				<span class="n">printf</span><span class="p">(</span><span class="n">COMM_NOT_FOUND</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">prg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">command</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">asm</span><span class="p">(</span><span class="s">"int 33"</span> <span class="o">::</span><span class="s">"a"</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="n">terminal</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="linkld">link.ld</h3>
<p>将<code class="highlighter-rouge">wukos.asm</code>和<code class="highlighter-rouge">kernel.c</code>两个文件编译出来的内容连接起来。和<a href="https://wu-kan.github.io/posts/操作系统/实验/系统控制">上一个实验</a>中的完全相同，不再放出。</p>
<h3 id="prg1asmprg4asm">prg1.asm~prg4.asm</h3>
<p>由于多进程调用时会同时访问变量，因此每个用户程序需要重新维护自己的运行变量，而不能像之前一样通过系统调用提供唯一个入口了。</p>

<p>这里在实验二中实现的用户程序上修改、完善一下。</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">%macro</span> <span class="n">print</span> <span class="mi">5</span> <span class="c">; string, length, x, y, color</span>
	<span class="k">pusha</span>
	<span class="k">push</span> <span class="n">ax</span>
	<span class="k">push</span> <span class="n">bx</span>
	<span class="k">push</span> <span class="n">cx</span>
	<span class="k">push</span> <span class="n">dx</span>
	<span class="k">push</span> <span class="n">bp</span>
	<span class="k">push</span> <span class="n">ds</span>
	<span class="k">push</span> <span class="n">es</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="n">b800H</span>
	<span class="k">mov</span> <span class="n">gs</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cs</span>
	<span class="k">mov</span> <span class="n">ds</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">bp</span><span class="p">,</span> <span class="kr">%1</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ds</span>
	<span class="k">mov</span> <span class="n">es</span><span class="p">,</span> <span class="n">ax</span>
	<span class="k">mov</span> <span class="n">cx</span><span class="p">,</span> <span class="kr">%2</span>
	<span class="k">mov</span> <span class="n">ax</span><span class="p">,</span> <span class="mi">1300</span><span class="n">H</span>
	<span class="k">mov</span> <span class="n">dh</span><span class="p">,</span> <span class="kr">%3</span>
	<span class="k">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="kr">%4</span>
	<span class="k">mov</span> <span class="n">bx</span><span class="p">,</span> <span class="kr">%5</span>
	<span class="k">int</span> <span class="mi">10</span><span class="n">H</span>
	<span class="k">pop</span> <span class="n">es</span>
	<span class="k">pop</span> <span class="n">ds</span>
	<span class="k">pop</span> <span class="n">bp</span>
	<span class="k">pop</span> <span class="n">dx</span>
	<span class="k">pop</span> <span class="n">cx</span>
	<span class="k">pop</span> <span class="n">bx</span>
	<span class="k">pop</span> <span class="n">ax</span>
	<span class="k">popa</span>
<span class="cp">%endmacro</span>
<span class="n">N</span> <span class="k">equ</span> <span class="mi">12</span>	<span class="c">;显示区域高度</span>
<span class="n">M</span> <span class="k">equ</span> <span class="mi">32</span>	<span class="c">;显示区域宽度减去字符串长度</span>
<span class="n">TOP</span> <span class="k">equ</span> <span class="mi">2</span>	<span class="c">;显示区域上端点</span>
<span class="n">LEFT</span> <span class="k">equ</span> <span class="mi">40</span>	<span class="c">;显示区域左端点</span>
<span class="n">LENGTH</span> <span class="k">equ</span> <span class="mi">8</span>	<span class="c">;字符串的长度</span>
<span class="n">DELAY</span> <span class="k">equ</span> <span class="mi">99999999</span>
<span class="n">org</span> <span class="mi">0</span><span class="n">A100h</span>
<span class="n">myLoop</span><span class="o">:</span>
	<span class="k">dec</span> <span class="n">dword</span><span class="p">[count]</span>	<span class="c">; 递减计数变量</span>
	<span class="k">jnz</span> <span class="n">myLoop</span>	<span class="c">; &gt;0：跳转</span>
	<span class="k">mov</span> <span class="n">dword</span><span class="p">[count],</span> <span class="n">DELAY</span>

	<span class="k">mov</span> <span class="n">word</span> <span class="n">ax</span><span class="p">,</span> <span class="p">[t]</span>	<span class="c">; ax = t</span>
	<span class="k">mov</span> <span class="n">word</span> <span class="n">bx</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span>
	<span class="k">xor</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dx</span>	<span class="c">; clear dx and prepare for division</span>
	<span class="k">div</span> <span class="n">bx</span>  <span class="c">; dx = t mod (2N - 2)</span>
	<span class="k">cmp</span> <span class="n">dx</span><span class="p">,</span> <span class="n">N</span> <span class="c">; compare dx and n</span>
	<span class="k">jb</span> <span class="n">xok</span>  <span class="c">; if (dx &lt; n) jump xok</span>
	<span class="k">sub</span> <span class="n">bx</span><span class="p">,</span> <span class="n">dx</span>
	<span class="k">mov</span> <span class="n">dx</span><span class="p">,</span> <span class="n">bx</span> <span class="c">; dx = 2n - 2 - dx</span>
<span class="n">xok</span><span class="o">:</span>
	<span class="k">mov</span> <span class="n">word</span><span class="p">[x],</span> <span class="n">dx</span>
	<span class="k">add</span> <span class="n">word</span><span class="p">[x],</span> <span class="n">TOP</span>

	<span class="k">mov</span> <span class="n">word</span> <span class="n">ax</span><span class="p">,</span> <span class="p">[t]</span>
	<span class="k">mov</span> <span class="n">word</span> <span class="n">bx</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="o">-</span><span class="mi">2</span>
	<span class="k">xor</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dx</span>
	<span class="k">div</span> <span class="n">bx</span>
	<span class="k">cmp</span> <span class="n">dx</span><span class="p">,</span> <span class="n">M</span>
	<span class="k">jb</span> <span class="n">yok</span>
	<span class="k">sub</span> <span class="n">bx</span><span class="p">,</span> <span class="n">dx</span>
	<span class="k">mov</span> <span class="n">dx</span><span class="p">,</span> <span class="n">bx</span>
<span class="n">yok</span><span class="o">:</span>
	<span class="k">mov</span> <span class="n">word</span> <span class="p">[y],</span><span class="n">dx</span>
	<span class="k">add</span> <span class="n">word</span> <span class="p">[y],</span><span class="n">LEFT</span>

	<span class="n">print</span> <span class="n">message</span><span class="p">,</span><span class="n">LENGTH</span><span class="p">,[x],[y],</span><span class="mi">07</span><span class="n">H</span>
	<span class="k">inc</span> <span class="n">word</span><span class="p">[t]</span>
	<span class="k">mov</span> <span class="n">word</span> <span class="n">ax</span><span class="p">,[t]</span>
	<span class="k">cmp</span> <span class="n">ax</span><span class="p">,</span> <span class="mi">63</span>
	<span class="k">jne</span> <span class="n">myLoop</span>
	<span class="k">ret</span>
<span class="n">datadef</span><span class="o">:</span>
	<span class="n">count</span> <span class="kt">dd</span> <span class="mi">1</span>
	<span class="n">t</span> <span class="n">dw</span> <span class="mi">0</span>
	<span class="n">x</span> <span class="n">dw</span> <span class="mi">1</span>
	<span class="n">y</span> <span class="n">dw</span> <span class="mi">0</span>
	<span class="n">message</span> <span class="kt">db</span> <span class="err">'</span> <span class="n">wu</span><span class="o">-</span><span class="n">kan</span> <span class="err">'</span>
</code></pre></div></div>
<p>上面是prg1.asm的内容，其余同理，不再放出。</p>
<h3 id="makefile">Makefile</h3>
<p>和<a href="https://wu-kan.github.io/posts/操作系统/实验/系统控制">上一个实验</a>完全相同，不再放出。</p>
<h2 id="运行结果">运行结果</h2>
<p>输入<code class="highlighter-rouge">prg4</code>，通过系统中断打开一个用户程序。可以看到系统中断服务仍然可以工作。
<img src="/public/image/2019-05-06-1.jpg" alt="" />
输入<code class="highlighter-rouge">ps</code>，显示当前进程的状态。当前只有一个进程，即内核，在运行。
<img src="/public/image/2019-05-06-2.jpg" alt="" />
输入<code class="highlighter-rouge">kill</code>后输入<code class="highlighter-rouge">0</code>，杀掉pid为0的内核。可以看到无法杀掉内核进程。
<img src="/public/image/2019-05-06-3.jpg" alt="" />
输入<code class="highlighter-rouge">execpro</code>，多进程的打开四个用户程序。可以看到，成功文体四开花了，而且四个象限的运行速度不一样。
<img src="/public/image/2019-05-06-4.jpg" alt="" /></p>
<h1 id="实验总结">实验总结</h1>
<p>这次实验让我深入了解了多进程时间片轮转的工作原理。原理很简单，就是<code class="highlighter-rouge">save</code>,<code class="highlighter-rouge">schedule</code>和<code class="highlighter-rouge">restart</code>，但实现起来可不简单。</p>

<p>在<code class="highlighter-rouge">save</code>过程和<code class="highlighter-rouge">restart</code>过程中，最容易出错是栈。当前栈内元素是什么，这个一定要非常清楚。当使用<code class="highlighter-rouge">call</code>操作和<code class="highlighter-rouge">ret</code>操作时，会修改堆栈。所以应尽量避免使用<code class="highlighter-rouge">call</code>和<code class="highlighter-rouge">ret</code>操作，避免出错。另外，<code class="highlighter-rouge">ss</code>和<code class="highlighter-rouge">sp</code>的保存时机也是非常关键的。<code class="highlighter-rouge">ss</code>和<code class="highlighter-rouge">sp</code>必须在最后保存，这样做是为了保存弹出<code class="highlighter-rouge">flags</code>,<code class="highlighter-rouge">cs</code>,<code class="highlighter-rouge">ip</code>之后的栈指针。</p>

<p>在<code class="highlighter-rouge">schedule</code>过程中，更容易在栈的问题上出错。<code class="highlighter-rouge">schedule</code>的栈要与<code class="highlighter-rouge">kernel</code>的栈以及用户程序的栈都不一样，否则会覆盖原有的数据。一旦踩进这个坑，就很难跳出来，因为你会发现寄存器之类的全部都是对的，只有栈内元素是错的。</p>

<p>另外在汇编代码调用C函数之前要<code class="highlighter-rouge">push 0</code>，传参数的时候也有很多细节，感谢我的室友添伦大哥对我的帮助！</p>
