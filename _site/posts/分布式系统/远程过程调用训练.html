<h2 id="问题描述">问题描述</h2>

<p>远程过程调用（RPC）将网络编程变得非常简单。根据所学的RPC相关原理，实现客户端-服务器通信，并进行简单的计算如数据库查询、算术计算、数据挖掘、深度学习推导等。</p>

<h3 id="要求">要求</h3>

<ol>
  <li>采用gRPC</li>
  <li>采用Protobuf作为C-S数据传输格式</li>
  <li>服务器端采用线程池，支持并发</li>
  <li>支持至少两种的计算服务如简单的算术运算+数据挖掘算法（K-means、KNN等）</li>
  <li>编程语言不做要求</li>
</ol>

<h3 id="建议">建议</h3>

<p>gRPC和Protobuf在配置环境时可能有些复杂， 对于有些编程语言如C++、go等会有一些挑战， Python问题会少一些。</p>

<h2 id="解决方案">解决方案</h2>

<p>人生苦短，选择Python。</p>

<h3 id="开发环境">开发环境</h3>

<h4 id="硬件">硬件</h4>

<p>所用机器型号为VAIO Z Flip 2016</p>

<ul>
  <li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
  <li>8.00GB RAM</li>
</ul>

<h4 id="软件">软件</h4>

<ul>
  <li>Windows 10, 64-bit (Build 17763) 10.0.17763</li>
  <li>Visual Studio Code 1.39.2
    <ul>
      <li>Python 2019.10.41019：九月底发布的VSCode Python插件支持在编辑器窗口内原生运行juyter nootbook了，非常赞！</li>
      <li>Remote - WSL 0.39.9：配合WSL，在Windows上获得Linux接近原生环境的体验。</li>
    </ul>
  </li>
  <li>Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]：WSL是以软件的形式运行在Windows下的 Linux子系统，是近些年微软推出来的新工具，可以在Windows系统上原生运行Linux。
    <ul>
      <li>Python 3.7.4 64-bit (‘anaconda3’:virtualenv)：安装在WSL中。</li>
    </ul>
  </li>
</ul>

<h5 id="安装grpc的python环境">安装<code class="highlighter-rouge">gRPC</code>的<code class="highlighter-rouge">python</code>环境</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> pip install grpcio grpcio-tools
</code></pre></div></div>

<h3 id="源代码">源代码</h3>

<p>这里实现了简单的求阶乘运算和基于<code class="highlighter-rouge">sklearn</code>实现的KNN算法。</p>

<h4 id="wuk_hw3proto"><code class="highlighter-rouge">wuk_hw3.proto</code></h4>

<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
<span class="kd">service</span> <span class="n">Greeter</span> <span class="p">{</span>
    <span class="k">rpc</span> <span class="n">KNN</span><span class="p">(</span><span class="n">KNNargs</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Vector</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">rpc</span> <span class="n">CalculateFactorial</span><span class="p">(</span><span class="n">Int32</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Int32</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">Vector</span> <span class="p">{</span>
    <span class="k">repeated</span> <span class="kt">float</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">Matrix</span> <span class="p">{</span>
    <span class="k">repeated</span> <span class="n">Vector</span> <span class="na">value</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">KNNargs</span> <span class="p">{</span>
    <span class="n">Vector</span> <span class="na">train_y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Matrix</span> <span class="na">train_x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Matrix</span> <span class="na">test_x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">Int32</span> <span class="p">{</span>
    <span class="kt">int32</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="wuk_hw3_serverpy"><code class="highlighter-rouge">wuk_hw3_server.py</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">wuk_hw3_pb2</span>
<span class="kn">import</span> <span class="nn">wuk_hw3_pb2_grpc</span>


<span class="k">class</span> <span class="nc">Greeter</span><span class="p">(</span><span class="n">wuk_hw3_pb2_grpc</span><span class="o">.</span><span class="n">GreeterServicer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">KNN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">testx</span><span class="p">,</span> <span class="n">trainx</span><span class="p">,</span> <span class="n">trainy</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">test_x</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="n">testx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">train_x</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="n">trainx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">train_y</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">trainy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">()</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trainx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trainy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">testx</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">CalculateFactorial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Int32</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ans</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">wuk_hw3_pb2_grpc</span><span class="o">.</span><span class="n">add_GreeterServicer_to_server</span><span class="p">(</span><span class="n">Greeter</span><span class="p">(),</span> <span class="n">server</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">add_insecure_port</span><span class="p">(</span><span class="s">'[::]:50051'</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">wait_for_termination</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="wuk_hw3_clientpy"><code class="highlighter-rouge">wuk_hw3_client.py</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">wuk_hw3_pb2</span>
<span class="kn">import</span> <span class="nn">wuk_hw3_pb2_grpc</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
    <span class="n">stub</span> <span class="o">=</span> <span class="n">wuk_hw3_pb2_grpc</span><span class="o">.</span><span class="n">GreeterStub</span><span class="p">(</span>
        <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s">'localhost:50051'</span><span class="p">))</span>
    <span class="n">iris</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">()</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">trainx</span><span class="p">,</span> <span class="n">testx</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">X_train</span><span class="p">:</span>
        <span class="n">trainx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">X_test</span><span class="p">:</span>
        <span class="n">testx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"using knn to test iris</span><span class="se">\'</span><span class="s">dataset: "</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">KNN</span><span class="p">(</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">KNNargs</span><span class="p">(</span>
        <span class="n">train_x</span><span class="o">=</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">trainx</span><span class="p">),</span> <span class="n">train_y</span><span class="o">=</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Y_train</span><span class="p">),</span>
        <span class="n">test_x</span><span class="o">=</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">testx</span><span class="p">)))</span>
    <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"result: "</span><span class="p">,</span> <span class="n">res_list</span><span class="p">)</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">CalculateFactorial</span><span class="p">(</span><span class="n">wuk_hw3_pb2</span><span class="o">.</span><span class="n">Int32</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"9! = "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fac</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="实验结果">实验结果</h2>

<h3 id="编译protobuf">编译Protobuf</h3>

<p>运行下述代码之后，目录下生成<code class="highlighter-rouge">wuk_hw3_pb2.py</code>和<code class="highlighter-rouge">wuk_hw3_pb2_grpc.py</code>两个文件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> grpc_tools.protoc <span class="nt">--python_out</span><span class="o">=</span><span class="nb">.</span> <span class="nt">--grpc_python_out</span><span class="o">=</span><span class="nb">.</span> <span class="nt">-I</span><span class="nb">.</span> wuk_hw3.proto
</code></pre></div></div>

<h3 id="服务端">服务端</h3>

<p>运行下述代码，启动服务器进程。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python wuk_hw3_server.py
</code></pre></div></div>

<h3 id="客户端">客户端</h3>

<p>新开终端运行下述代码，启动客户端和服务器进行通信。可以看到，成功输出了在<code class="highlighter-rouge">sklearn</code>的样例数据集上跑<code class="highlighter-rouge">KNN</code>算法的结果和九的阶乘。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python wuk_hw3_client.py
using knn to <span class="nb">test </span>iris<span class="s1">'dataset:  [[7.1, 3.0, 5.9, 2.1], [5.7, 3.0, 4.2, 1.2], [5.9, 3.0, 5.1, 1.8], [5.7, 2.8, 4.5, 1.3], [7.7, 3.0, 6.1, 2.3], [6.5, 3.2, 5.1, 2.0], [5.2, 3.4, 1.4, 0.2], [5.6, 2.9, 3.6, 1.3], [4.6, 3.1, 1.5, 0.2], [5.5, 3.5, 1.3, 0.2], [6.0, 3.4, 4.5, 1.6], [6.8, 3.0, 5.5, 2.1], [7.9, 3.8, 6.4, 2.0], [6.1, 3.0, 4.9, 1.8], [6.8, 3.2, 5.9, 2.3], [6.0, 3.0, 4.8, 1.8], [6.2, 2.8, 4.8, 1.8], [6.3, 2.5, 5.0, 1.9], [6.7, 3.3, 5.7, 2.1], [6.3, 2.9, 5.6, 1.8], [4.9, 3.1, 1.5, 0.1], [7.7, 3.8, 6.7, 2.2], [6.0, 2.2, 4.0, 1.0], [4.4, 2.9, 1.4, 0.2], [5.8, 2.7, 3.9, 1.2], [4.9, 2.4, 3.3, 1.0], [4.5, 2.3, 1.3, 0.3], [4.9, 3.0, 1.4, 0.2], [5.8, 2.7, 5.1, 1.9], [5.0, 3.4, 1.6, 0.4], [5.7, 2.8, 4.1, 1.3], [6.0, 2.7, 5.1, 1.6], [6.3, 2.8, 5.1, 1.5], [4.8, 3.1, 1.6, 0.2], [5.1, 2.5, 3.0, 1.1], [5.1, 3.8, 1.5, 0.3], [6.6, 2.9, 4.6, 1.3], [6.7, 3.0, 5.2, 2.3]]
result:  [2.0, 1.0, 2.0, 1.0, 2.0, 2.0, 0.0, 1.0, 0.0, 0.0, 1.0, 2.0, 2.0, 1.0, 2.0, 1.0, 1.0, 2.0, 2.0, 2.0, 0.0, 2.0, 1.0, 0.0, 1.0, 1.0, 0.0, 0.0, 2.0, 0.0, 1.0, 2.0, 1.0, 0.0, 1.0, 0.0, 1.0, 2.0]
9! =  362880
</span></code></pre></div></div>

<h2 id="遇到的问题及解决方法">遇到的问题及解决方法</h2>

<p>只要代码能跑起来，很多难题慢慢都会得到解决。参考官方文档，写了第一个<code class="highlighter-rouge">gRPC</code>的<code class="highlighter-rouge">HelloWorld</code>示例，随后要求的功能均在此之上一点点增量开发出来。</p>

<ul>
  <li><a href="https://grpc.io/docs/quickstart/python/">Python Quick Start</a></li>
  <li><a href="https://grpc.io/docs/tutorials/basic/python/">gRPC Basics - Python</a></li>
</ul>
